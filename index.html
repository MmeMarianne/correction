<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme Enseignant et Élève - Outil d'Autocorrection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Intégration Firebase CORRIGÉE -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        // Your web app's Firebase configuration - COMPLÈTE
        const firebaseConfig = {
            apiKey: "AIzaSyBQ2x6iR0yeQE0mGvWKnEe4H01fhhr91JM",
            authDomain: "ateliers-af899.firebaseapp.com",
            databaseURL: "https://ateliers-af899-default-rtdb.firebaseio.com",
            projectId: "ateliers-af899",
            storageBucket: "ateliers-af899.firebasestorage.app",
            messagingSenderId: "297753369500",
            appId: "1:297753369500:web:7177e451c0e619fe064659",
            measurementId: "G-V80VY8XMPY"
        };

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            const database = getDatabase(app);

            console.log('Firebase initialisé avec succès');
            
            // Rendre Firebase accessible globalement
            window.firebaseApp = app;
            window.firebaseDatabase = database;
            window.firebaseRef = ref;
            window.firebaseSet = set;
            window.firebaseGet = get;
            window.firebaseChild = child;
            window.firebaseInitialized = true;
            
            // Mettre à jour le statut
            updateFirebaseStatus('Firebase: Connecté', true);
            
        } catch (error) {
            console.error('Erreur lors de l\'initialisation de Firebase:', error);
            window.firebaseInitialized = false;
            updateFirebaseStatus('Firebase: Erreur d\'initialisation', false);
        }

        function updateFirebaseStatus(message, isConnected) {
            const statusElement = document.getElementById('firebase-status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = isConnected ? 
                    'firebase-status firebase-connected' : 
                    'firebase-status firebase-error';
            }
        }
    </script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background: #4338ca;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .tab-button.active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        .question-item {
            transition: all 0.3s ease;
        }
        .question-item:hover {
            background-color: #f8fafc;
        }
        .activity-card {
            transition: all 0.3s ease;
        }
        .activity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.1);
        }
        .student-platform {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .platform-switcher {
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .student-header {
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 1rem;
            border-radius: 12px 12px 0 0;
        }
        .countdown {
            display: inline-block;
            padding: 2px 8px;
            background-color: #ef4444;
            color: white;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        .firebase-connected {
            background-color: #10b981;
            color: white;
        }
        .firebase-disconnected {
            background-color: #ef4444;
            color: white;
        }
        .firebase-error {
            background-color: #f59e0b;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Indicateur de statut Firebase -->
    <div id="firebase-status" class="firebase-status firebase-error">
        Firebase: Chargement...
    </div>

    <!-- Barre de navigation pour switcher entre les plateformes -->
    <div class="platform-switcher py-3 px-4 text-white">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Outil d'Autocorrection</h1>
            <div class="flex space-x-4">
                <button id="show-student-btn" class="px-4 py-2 bg-white text-purple-700 rounded-lg font-medium">Plateforme Élève</button>
                <button id="show-teacher-btn" class="px-4 py-2 bg-purple-500 text-white rounded-lg font-medium hover:bg-purple-600">Plateforme Enseignant</button>
            </div>
        </div>
    </div>

    <!-- Section Élève (visible par défaut) -->
    <div id="student-platform" class="student-platform">
        <div class="container max-w-4xl mx-auto">
            <div class="card">
                <!-- En-tête de la plateforme élève -->
                <div class="student-header flex justify-between items-center">
                    <h1 class="text-2xl font-bold">Espace Élève</h1>
                    <div id="student-welcome" class="hidden">
                        <span class="mr-4">Connecté en tant que: <strong id="current-student-name"></strong></span>
                        <button id="student-logout-btn" class="px-3 py-1 bg-white text-purple-700 rounded-md text-sm hover:bg-gray-100">
                            Déconnexion
                        </button>
                    </div>
                </div>
                
                <div class="p-8">
                    <div id="student-login-section">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-800">Connexion Élève</h2>
                            <p class="text-gray-600 mt-2">Sélectionnez votre classe et votre nom pour accéder aux activités</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sélectionnez votre classe</label>
                                <select id="class-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Choisissez votre classe</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sélectionnez votre nom</label>
                                <select id="student-name-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                                    <option value="">Choisissez votre nom</option>
                                </select>
                            </div>
                        </div>
                        
                        <button id="student-login-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" disabled>
                            Se connecter
                        </button>
                    </div>
                    
                    <div id="student-activities" class="hidden mt-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Vos activités</h2>
                        <div id="activities-container" class="space-y-4">
                            <!-- Activities will be loaded here -->
                        </div>
                    </div>
                    
                    <div id="student-activity-content" class="hidden mt-8">
                        <h2 id="current-activity-title" class="text-xl font-bold text-gray-800 mb-4"></h2>
                        <div id="questions-list" class="space-y-6">
                            <!-- Questions will be loaded here -->
                        </div>
                        
                        <div class="mt-8">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-700">Progression</span>
                                <span id="progress-percentage" class="text-sm font-medium text-gray-700">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <button id="back-to-activities" class="mt-6 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                            ← Retour aux activités
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Enseignant (cachée par défaut) -->
    <div id="teacher-platform" class="py-8 px-4 hidden">
        <div class="container">
            <div class="card p-6 mb-8">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-800">Outil d'Autocorrection - Plateforme Enseignant</h1>
                    <div class="flex items-center space-x-4">
                        <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                            Verrouiller
                        </button>
                    </div>
                </div>
                <p class="text-gray-600 mt-2">Gérez vos classes, activités et suivez les progrès de vos élèves</p>
            </div>

            <div id="login-section" class="card p-8 text-center">
                <div class="max-w-md mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Accès Enseignant</h2>
                    <p class="text-gray-600 mb-6">Veuillez saisir le mot de passe pour accéder à la plateforme</p>
                    
                    <div class="mb-6">
                        <input type="password" id="teacher-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Mot de passe enseignant">
                        <p id="password-error" class="text-red-500 text-sm mt-2 hidden">Mot de passe incorrect.</p>
                    </div>
                    
                    <button id="login-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Déverrouiller l'accès
                    </button>
                </div>
            </div>

            <div id="teacher-section" class="hidden">
                <div class="border-b border-gray-200 mb-8">
                    <nav class="flex space-x-8">
                        <button class="tab-button py-4 px-1 text-center font-medium text-sm text-gray-500 hover:text-gray-700 active" data-tab="classes">
                            Gestion des classes
                        </button>
                        <button class="tab-button py-4 px-1 text-center font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="activities">
                            Gestion des activités
                        </button>
                        <button class="tab-button py-4 px-1 text-center font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="results">
                            Résultats des élèves
                        </button>
                        <button class="tab-button py-4 px-1 text-center font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="export">
                            Export de données
                        </button>
                    </nav>
                </div>

                <div id="tab-content">
                    <!-- Onglet Gestion des classes -->
                    <div class="tab-pane active" id="classes-tab">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="card p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Créer une nouvelle classe</h2>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom de la classe</label>
                                        <input type="text" id="class-name" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ex: CM2-A">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Liste des élèves (un par ligne)</label>
                                        <textarea id="class-student-list" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Alice&#10;Bob&#10;Charlie"></textarea>
                                    </div>
                                </div>
                                
                                <button id="save-class-btn" class="mt-6 w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                    Créer la classe
                                </button>
                            </div>
                            
                            <div class="card p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Classes existantes</h2>
                                <p class="text-gray-600 mb-4">Gérez vos classes créées précédemment</p>
                                
                                <div id="classes-list" class="space-y-4">
                                    <div class="p-4 border border-gray-200 rounded-md text-center">
                                        <p class="text-gray-500">Aucune classe créée pour le moment</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Onglet Gestion des activités -->
                    <div class="tab-pane hidden" id="activities-tab">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="card p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Créer une nouvelle activité</h2>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom de l'activité</label>
                                        <input type="text" id="activity-name" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ex: Lecture - Le système solaire">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Délai entre les tentatives (secondes)</label>
                                        <input type="number" id="activity-delay" value="30" min="5" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Classes concernées</label>
                                        <select id="activity-classes" class="w-full px-3 py-2 border border-gray-300 rounded-md" multiple>
                                            <!-- Classes will be loaded here -->
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">Maintenez Ctrl (ou Cmd) pour sélectionner plusieurs classes</p>
                                    </div>
                                </div>
                                
                                <div class="mt-6">
                                    <h3 class="font-medium text-gray-800 mb-3">Questions de l'activité</h3>
                                    <div id="questions-container" class="space-y-3">
                                        <!-- Questions will be added here -->
                                    </div>
                                    <button id="add-question-btn" class="mt-3 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                                        + Ajouter une question
                                    </button>
                                </div>
                                
                                <button id="save-activity-btn" class="mt-6 w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                    Enregistrer l'activité
                                </button>
                            </div>
                            
                            <div class="card p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Activités existantes</h2>
                                <p class="text-gray-600 mb-4">Gérez vos activités créées précédemment</p>
                                
                                <div id="activities-list" class="space-y-4">
                                    <div class="p-4 border border-gray-200 rounded-md text-center">
                                        <p class="text-gray-500">Aucune activité créée pour le moment</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Onglet Résultats -->
                    <div class="tab-pane hidden" id="results-tab">
                        <div class="card p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">Résultats des élèves</h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Filtrer par activité</label>
                                    <select id="result-activity-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                        <option value="all">Toutes les activités</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Filtrer par élève</label>
                                    <select id="result-student-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                        <option value="all">Tous les élèves</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-md mb-6">
                                <h3 class="font-medium text-gray-800 mb-2">Résumé des résultats</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-white p-4 rounded-md text-center">
                                        <p class="text-2xl font-bold text-blue-600" id="total-attempts">0</p>
                                        <p class="text-sm text-gray-600">Tentatives totales</p>
                                    </div>
                                    <div class="bg-white p-4 rounded-md text-center">
                                        <p class="text-2xl font-bold text-green-600" id="correct-answers">0</p>
                                        <p class="text-sm text-gray-600">Réponses correctes</p>
                                    </div>
                                    <div class="bg-white p-4 rounded-md text-center">
                                        <p class="text-2xl font-bold text-purple-600" id="average-score">0%</p>
                                        <p class="text-sm text-gray-600">Score moyen</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="results-container">
                                <p class="text-gray-500 text-center py-4">Aucun résultat à afficher pour le moment</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Onglet Export -->
                    <div class="tab-pane hidden" id="export-tab">
                        <div class="card p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">Export des données</h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="bg-blue-50 p-5 rounded-lg">
                                    <h3 class="font-medium text-blue-800 mb-2">Exporter les activités</h3>
                                    <p class="text-blue-700 text-sm mb-4">Téléchargez toutes vos activités au format JSON pour les sauvegarder ou les importer ailleurs.</p>
                                    <button id="export-activities-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                        Exporter les activités
                                    </button>
                                </div>
                                
                                <div class="bg-green-50 p-5 rounded-lg">
                                    <h3 class="font-medium text-green-800 mb-2">Exporter les résultats</h3>
                                    <p class="text-green-700 text-sm mb-4">Téléchargez tous les résultats de vos élèves au format CSV pour les analyser dans Excel.</p>
                                    <button id="export-results-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                        Exporter les résultats
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-5 rounded-lg">
                                <h3 class="font-medium text-gray-800 mb-2">Générer un fichier élève</h3>
                                <p class="text-gray-700 text-sm mb-4">Créez un fichier HTML autonome que vous pouvez partager avec vos élèves pour qu'ils puissent accéder aux activités.</p>
                                <button id="generate-student-file-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                                    Générer le fichier élève
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour modifier une activité -->
    <div id="edit-activity-modal" class="modal">
        <div class="modal-content">
            <span class="close-button float-right text-2xl cursor-pointer">&times;</span>
            <h2 class="text-xl font-bold text-gray-800 mb-4">Modifier l'activité</h2>
            <div id="edit-activity-form">
                <!-- Le formulaire de modification sera généré ici -->
            </div>
        </div>
    </div>

    <!-- Modal pour modifier une classe -->
    <div id="edit-class-modal" class="modal">
        <div class="modal-content">
            <span class="close-button float-right text-2xl cursor-pointer">&times;</span>
            <h2 class="text-xl font-bold text-gray-800 mb-4">Modifier la classe</h2>
            <div id="edit-class-form">
                <!-- Le formulaire de modification sera généré ici -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Constants
            const TEACHER_PASSWORD = 'prof123';
            
            // DOM Elements
            const teacherPlatform = document.getElementById('teacher-platform');
            const studentPlatform = document.getElementById('student-platform');
            const showTeacherBtn = document.getElementById('show-teacher-btn');
            const showStudentBtn = document.getElementById('show-student-btn');
            const loginSection = document.getElementById('login-section');
            const teacherSection = document.getElementById('teacher-section');
            const teacherPasswordInput = document.getElementById('teacher-password');
            const loginBtn = document.getElementById('login-btn');
            const passwordError = document.getElementById('password-error');
            const logoutBtn = document.getElementById('logout-btn');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanes = document.querySelectorAll('.tab-pane');
            const firebaseStatus = document.getElementById('firebase-status');
            
            // Class management elements
            const classNameInput = document.getElementById('class-name');
            const classStudentList = document.getElementById('class-student-list');
            const saveClassBtn = document.getElementById('save-class-btn');
            const classesList = document.getElementById('classes-list');
            
            // Activity management elements
            const activityNameInput = document.getElementById('activity-name');
            const activityDelayInput = document.getElementById('activity-delay');
            const addQuestionBtn = document.getElementById('add-question-btn');
            const questionsContainer = document.getElementById('questions-container');
            const saveActivityBtn = document.getElementById('save-activity-btn');
            const activitiesList = document.getElementById('activities-list');
            const activityClassesSelect = document.getElementById('activity-classes');
            const exportActivitiesBtn = document.getElementById('export-activities-btn');
            const generateStudentFileBtn = document.getElementById('generate-student-file-btn');
            
            // Student platform elements
            const classSelect = document.getElementById('class-select');
            const studentLoginSection = document.getElementById('student-login-section');
            const studentNameSelect = document.getElementById('student-name-select');
            const studentLoginBtn = document.getElementById('student-login-btn');
            const studentWelcome = document.getElementById('student-welcome');
            const currentStudentName = document.getElementById('current-student-name');
            const studentLogoutBtn = document.getElementById('student-logout-btn');
            const studentActivities = document.getElementById('student-activities');
            const studentActivityContent = document.getElementById('student-activity-content');
            const activitiesContainer = document.getElementById('activities-container');
            const questionsList = document.getElementById('questions-list');
            const currentActivityTitle = document.getElementById('current-activity-title');
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');
            const backToActivities = document.getElementById('back-to-activities');
            
            // Modal elements
            const editActivityModal = document.getElementById('edit-activity-modal');
            const editActivityForm = document.getElementById('edit-activity-form');
            const editClassModal = document.getElementById('edit-class-modal');
            const editClassForm = document.getElementById('edit-class-form');
            const closeModalButtons = document.querySelectorAll('.close-button');
            
            // State
            let classes = [];
            let activities = [];
            let results = [];
            let questionCount = 0;
            let currentStudent = null;
            let currentActivity = null;
            let currentEditingActivity = null;
            let currentEditingClass = null;
            let questionTimeouts = {};
            
            // Firebase Functions - CORRIGÉES
            async function saveToFirebase(path, data) {
                // Sauvegarde locale par défaut
                localStorage.setItem(path, JSON.stringify(data));
                
                // Tentative de sauvegarde Firebase
                if (window.firebaseInitialized) {
                    try {
                        await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, path), data);
                        console.log('✅ Données sauvegardées sur Firebase');
                        updateFirebaseStatus('Firebase: Connecté', true);
                        return true;
                    } catch (error) {
                        console.warn('❌ Erreur Firebase, utilisation du stockage local:', error);
                        updateFirebaseStatus('Firebase: Erreur de sauvegarde', false);
                        return false;
                    }
                } else {
                    console.warn('Firebase non initialisé, utilisation du stockage local');
                    return false;
                }
            }
            
            async function loadFromFirebase(path) {
                // D'abord essayer Firebase
                if (window.firebaseInitialized) {
                    try {
                        const snapshot = await window.firebaseGet(
                            window.firebaseChild(window.firebaseRef(window.firebaseDatabase), path)
                        );
                        if (snapshot.exists()) {
                            console.log('✅ Données chargées depuis Firebase');
                            updateFirebaseStatus('Firebase: Connecté', true);
                            return snapshot.val();
                        }
                    } catch (error) {
                        console.warn('❌ Erreur Firebase, utilisation du stockage local:', error);
                        updateFirebaseStatus('Firebase: Erreur de chargement', false);
                    }
                }
                
                // Fallback au localStorage
                const localData = localStorage.getItem(path);
                if (localData) {
                    console.log('📁 Données chargées depuis le stockage local');
                    return JSON.parse(localData);
                }
                return null;
            }

            function updateFirebaseStatus(message, isConnected) {
                const statusElement = document.getElementById('firebase-status');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = isConnected ? 
                        'firebase-status firebase-connected' : 
                        'firebase-status firebase-error';
                }
            }
            
            async function saveClasses() {
                const classesObject = {};
                classes.forEach((classItem, index) => {
                    classesObject[index] = classItem;
                });
                return await saveToFirebase('classes', classesObject);
            }
            
            async function saveActivities() {
                const activitiesObject = {};
                activities.forEach((activity, index) => {
                    activitiesObject[index] = activity;
                });
                return await saveToFirebase('activities', activitiesObject);
            }
            
            async function saveResults() {
                const resultsObject = {};
                results.forEach((result, index) => {
                    resultsObject[index] = result;
                });
                return await saveToFirebase('results', resultsObject);
            }
            
            // Initialize the app
            async function init() {
                console.log('🚀 Initialisation de l\'application...');
                
                // Attendre que Firebase soit chargé
                let firebaseLoaded = false;
                for (let i = 0; i < 50; i++) {
                    if (window.firebaseInitialized !== undefined) {
                        firebaseLoaded = true;
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                if (!firebaseLoaded) {
                    console.warn('Firebase ne s\'est pas initialisé dans le délai imparti');
                    updateFirebaseStatus('Firebase: Timeout', false);
                }
                
                await loadData();
                renderClassesList();
                renderActivitiesList();
                updateResultsSummary();
                populateClassSelect();
                populateActivityClasses();
                
                // Afficher la plateforme élève par défaut
                showStudentPlatform();
                
                console.log('✅ Application initialisée');
            }
            
            async function loadData() {
                // Charger les classes depuis Firebase
                const classesData = await loadFromFirebase('classes');
                classes = classesData ? Object.values(classesData) : [];
                
                // Charger les activités depuis Firebase
                const activitiesData = await loadFromFirebase('activities');
                activities = activitiesData ? Object.values(activitiesData) : [];
                
                // Charger les résultats depuis Firebase
                const resultsData = await loadFromFirebase('results');
                results = resultsData ? Object.values(resultsData) : [];
                
                console.log('Données chargées:', { classes, activities, results });
            }
            
            // Show teacher platform
            showTeacherBtn.addEventListener('click', function() {
                showTeacherPlatform();
            });
            
            // Show student platform
            showStudentBtn.addEventListener('click', function() {
                showStudentPlatform();
                resetStudentPlatform();
            });
            
            function showTeacherPlatform() {
                studentPlatform.classList.add('hidden');
                teacherPlatform.classList.remove('hidden');
                showTeacherBtn.classList.add('bg-white', 'text-purple-700');
                showStudentBtn.classList.remove('bg-white', 'text-purple-700');
                showStudentBtn.classList.add('bg-purple-500', 'text-white');
            }
            
            function showStudentPlatform() {
                teacherPlatform.classList.add('hidden');
                studentPlatform.classList.remove('hidden');
                showStudentBtn.classList.add('bg-white', 'text-purple-700');
                showTeacherBtn.classList.remove('bg-white', 'text-purple-700');
                showTeacherBtn.classList.add('bg-purple-500', 'text-white');
            }
            
            // Reset student platform to login state
            function resetStudentPlatform() {
                studentLoginSection.classList.remove('hidden');
                studentWelcome.classList.add('hidden');
                studentActivities.classList.add('hidden');
                studentActivityContent.classList.add('hidden');
                currentStudent = null;
                classSelect.value = "";
                studentNameSelect.value = "";
                studentNameSelect.disabled = true;
                studentLoginBtn.disabled = true;
            }
            
            // Login functionality
            loginBtn.addEventListener('click', function() {
                const password = teacherPasswordInput.value.trim();
                
                if (password === TEACHER_PASSWORD) {
                    // Successful login
                    loginSection.classList.add('hidden');
                    teacherSection.classList.remove('hidden');
                    logoutBtn.classList.remove('hidden');
                    passwordError.classList.add('hidden');
                    teacherPasswordInput.classList.remove('shake');
                } else {
                    // Failed login
                    passwordError.classList.remove('hidden');
                    teacherPasswordInput.classList.add('shake');
                    setTimeout(() => {
                        teacherPasswordInput.classList.remove('shake');
                    }, 500);
                }
            });
            
            // Logout functionality
            logoutBtn.addEventListener('click', function() {
                loginSection.classList.remove('hidden');
                teacherSection.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                teacherPasswordInput.value = '';
            });
            
            // Class selection change
            classSelect.addEventListener('change', function() {
                const classId = this.value;
                
                if (classId) {
                    const selectedClass = classes.find(c => c.id == classId);
                    populateStudentSelect(selectedClass);
                    studentNameSelect.disabled = false;
                } else {
                    studentNameSelect.innerHTML = '<option value="">Choisissez votre nom</option>';
                    studentNameSelect.disabled = true;
                    studentLoginBtn.disabled = true;
                }
            });
            
            // Student selection change
            studentNameSelect.addEventListener('change', function() {
                studentLoginBtn.disabled = !this.value;
            });
            
            // Populate student select based on class
            function populateStudentSelect(classData) {
                studentNameSelect.innerHTML = '<option value="">Choisissez votre nom</option>';
                
                if (classData && classData.students) {
                    classData.students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student;
                        option.textContent = student;
                        studentNameSelect.appendChild(option);
                    });
                }
            }
            
            // Student login functionality
            studentLoginBtn.addEventListener('click', function() {
                const className = classSelect.options[classSelect.selectedIndex].text;
                const studentName = studentNameSelect.value;
                
                if (!studentName) {
                    alert('Veuillez sélectionner votre nom');
                    return;
                }
                
                currentStudent = {
                    name: studentName,
                    className: className,
                    classId: classSelect.value
                };
                
                // Update UI
                studentLoginSection.classList.add('hidden');
                studentWelcome.classList.remove('hidden');
                studentActivities.classList.remove('hidden');
                currentStudentName.textContent = `${currentStudent.name} (${currentStudent.className})`;
                
                // Load student activities
                loadStudentActivities();
            });
            
            // Student logout functionality
            studentLogoutBtn.addEventListener('click', function() {
                resetStudentPlatform();
            });
            
            // Load student activities
            function loadStudentActivities() {
                activitiesContainer.innerHTML = '';
                
                // Filtrer les activités pour ne montrer que celles assignées à la classe de l'élève
                const studentActivitiesList = activities.filter(activity => 
                    activity.classes && activity.classes.includes(currentStudent.classId)
                );
                
                console.log('Activités filtrées pour élève:', studentActivitiesList);
                
                if (studentActivitiesList.length === 0) {
                    activitiesContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Aucune activité disponible pour le moment</p>';
                    return;
                }
                
                studentActivitiesList.forEach(activity => {
                    const activityElement = document.createElement('div');
                    activityElement.classList.add('p-4', 'border', 'border-gray-200', 'rounded-md', 'hover:bg-gray-50', 'cursor-pointer');
                    activityElement.innerHTML = `
                        <h3 class="font-medium text-gray-800">${activity.name}</h3>
                        <p class="text-sm text-gray-600">${activity.questions ? activity.questions.length : 0} questions • Délai: ${activity.delay}s</p>
                    `;
                    
                    activityElement.addEventListener('click', () => {
                        currentActivity = activity;
                        loadActivityQuestions();
                    });
                    
                    activitiesContainer.appendChild(activityElement);
                });
            }
            
            // Load activity questions with answer validation
            function loadActivityQuestions() {
                studentActivities.classList.add('hidden');
                studentActivityContent.classList.remove('hidden');
                currentActivityTitle.textContent = currentActivity.name;
                
                questionsList.innerHTML = '';
                
                if (!currentActivity.questions || currentActivity.questions.length === 0) {
                    questionsList.innerHTML = '<p class="text-gray-500 text-center py-4">Aucune question dans cette activité</p>';
                    return;
                }
                
                currentActivity.questions.forEach((question, index) => {
                    const questionElement = document.createElement('div');
                    questionElement.classList.add('p-4', 'bg-gray-50', 'rounded-md');
                    questionElement.innerHTML = `
                        <h3 class="font-medium text-gray-800 mb-2">Question ${index + 1}</h3>
                        <p class="text-gray-700 mb-3">${question.text}</p>
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md student-answer" placeholder="Votre réponse" data-question-id="${question.id}">
                        <div class="feedback mt-2 text-sm hidden"></div>
                    `;
                    
                    const answerInput = questionElement.querySelector('.student-answer');
                    const feedbackEl = questionElement.querySelector('.feedback');
                    
                    answerInput.addEventListener('blur', () => {
                        validateAnswer(question, answerInput, feedbackEl);
                    });
                    
                    answerInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            validateAnswer(question, answerInput, feedbackEl);
                        }
                    });
                    
                    questionsList.appendChild(questionElement);
                });
            }
            
            // Validate student answer with delay
            function validateAnswer(question, inputElement, feedbackEl) {
                const userAnswer = inputElement.value.trim();
                
                if (!userAnswer) return;
                
                const isCorrect = userAnswer.toLowerCase() === question.answer.toLowerCase();
                
                if (isCorrect) {
                    feedbackEl.textContent = 'Bravo ! Réponse correcte.';
                    feedbackEl.className = 'feedback mt-2 text-sm text-green-600 font-bold';
                    inputElement.disabled = true;
                    inputElement.classList.add('bg-green-100', 'border-green-400');
                    updateProgress();
                    
                    // Sauvegarder le résultat
                    saveResult(currentStudent, currentActivity, question, true);
                } else {
                    feedbackEl.textContent = `Incorrect. Vous pourrez réessayer dans ${currentActivity.delay} secondes.`;
                    feedbackEl.className = 'feedback mt-2 text-sm text-red-600 font-bold';
                    inputElement.disabled = true;
                    inputElement.classList.add('bg-red-100', 'border-red-400');
                    
                    // Sauvegarder le résultat (échec)
                    saveResult(currentStudent, currentActivity, question, false);
                    
                    // Set timeout to allow retry after delay
                    const questionId = question.id;
                    
                    if (questionTimeouts[questionId]) {
                        clearTimeout(questionTimeouts[questionId]);
                    }
                    
                    let secondsLeft = currentActivity.delay;
                    updateCountdown(feedbackEl, secondsLeft);
                    
                    questionTimeouts[questionId] = setInterval(() => {
                        secondsLeft--;
                        
                        if (secondsLeft <= 0) {
                            clearInterval(questionTimeouts[questionId]);
                            inputElement.disabled = false;
                            inputElement.value = '';
                            inputElement.classList.remove('bg-red-100', 'border-red-400');
                            feedbackEl.textContent = '';
                            delete questionTimeouts[questionId];
                        } else {
                            updateCountdown(feedbackEl, secondsLeft);
                        }
                    }, 1000);
                }
            }
            
            // Sauvegarder un résultat
            async function saveResult(student, activity, question, isCorrect) {
                const result = {
                    id: Date.now(),
                    studentName: student.name,
                    studentClass: student.className,
                    activityId: activity.id,
                    activityName: activity.name,
                    questionId: question.id,
                    questionText: question.text,
                    studentAnswer: document.querySelector(`[data-question-id="${question.id}"]`).value,
                    correctAnswer: question.answer,
                    isCorrect: isCorrect,
                    timestamp: new Date().toISOString()
                };
                
                results.push(result);
                await saveResults();
                updateResultsSummary();
            }
            
            // Update countdown display
            function updateCountdown(feedbackEl, secondsLeft) {
                feedbackEl.innerHTML = `Incorrect. Vous pourrez réessayer dans <span class="countdown">${secondsLeft}s</span>.`;
            }
            
            // Update progress bar
            function updateProgress() {
                const answeredQuestions = document.querySelectorAll('.student-answer:disabled').length;
                const totalQuestions = currentActivity.questions.length;
                const progressPercent = Math.round((answeredQuestions / totalQuestions) * 100);
                
                progressBar.style.width = `${progressPercent}%`;
                progressPercentage.textContent = `${progressPercent}%`;
            }
            
            // Back to activities list
            backToActivities.addEventListener('click', function() {
                // Clear all timeouts
                Object.values(questionTimeouts).forEach(timeout => {
                    clearInterval(timeout);
                });
                questionTimeouts = {};
                
                studentActivityContent.classList.add('hidden');
                studentActivities.classList.remove('hidden');
                currentActivity = null;
            });
            
            // Populate class select for students
            function populateClassSelect() {
                classSelect.innerHTML = '<option value="">Choisissez votre classe</option>';
                
                classes.forEach(classItem => {
                    const option = document.createElement('option');
                    option.value = classItem.id;
                    option.textContent = classItem.name;
                    classSelect.appendChild(option);
                });
            }
            
            // Populate classes for activity assignment
            function populateActivityClasses() {
                activityClassesSelect.innerHTML = '';
                
                classes.forEach(classItem => {
                    const option = document.createElement('option');
                    option.value = classItem.id;
                    option.textContent = classItem.name;
                    activityClassesSelect.appendChild(option);
                });
            }
            
            // Tab switching
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Update active tab button
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show active tab pane
                    tabPanes.forEach(pane => pane.classList.add('hidden'));
                    document.getElementById(`${tabId}-tab`).classList.remove('hidden');
                    
                    // Re-render lists when switching tabs
                    if (tabId === 'classes') {
                        renderClassesList();
                    } else if (tabId === 'activities') {
                        renderActivitiesList();
                    } else if (tabId === 'results') {
                        renderResultsList();
                    }
                });
            });
            
            // Save class functionality
            saveClassBtn.addEventListener('click', async function() {
                const name = classNameInput.value.trim();
                const studentsText = classStudentList.value;
                
                // Nettoyer la liste des élèves
                const students = studentsText.split('\n')
                    .map(s => s.trim())
                    .filter(s => s);
                
                // Validate inputs
                if (!name) {
                    alert('Veuillez donner un nom à votre classe');
                    return;
                }
                
                if (students.length === 0) {
                    alert('Veuillez ajouter au moins un élève');
                    return;
                }
                
                // Create class object
                const classItem = {
                    id: Date.now(),
                    name,
                    students,
                    createdAt: new Date().toISOString()
                };
                
                // Save class
                classes.push(classItem);
                const success = await saveClasses();
                
                if (success) {
                    // Reset form
                    classNameInput.value = '';
                    classStudentList.value = '';
                    
                    // Update UI
                    renderClassesList();
                    populateClassSelect();
                    populateActivityClasses();
                    
                    alert('Classe créée avec succès!');
                } else {
                    alert('Erreur lors de la sauvegarde. Les données seront stockées localement.');
                }
            });
            
            // Add question functionality
            addQuestionBtn.addEventListener('click', function() {
                questionCount++;
                const questionId = Date.now();
                const questionElement = document.createElement('div');
                questionElement.classList.add('question-item', 'p-3', 'border', 'border-gray-200', 'rounded-md');
                questionElement.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md question-text" placeholder="Question ${questionCount}" data-id="${questionId}">
                        </div>
                        <div>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md question-answer" placeholder="Réponse attendue" data-id="${questionId}">
                        </div>
                    </div>
                    <button class="mt-2 px-3 py-1 bg-red-500 text-white text-sm rounded-md delete-question" data-id="${questionId}">Supprimer</button>
                `;
                questionsContainer.appendChild(questionElement);
                
                // Add delete event listener
                questionElement.querySelector('.delete-question').addEventListener('click', function() {
                    questionElement.remove();
                });
            });
            
            // Save activity functionality
            saveActivityBtn.addEventListener('click', async function() {
                const name = activityNameInput.value.trim();
                const delay = parseInt(activityDelayInput.value);
                const selectedClasses = Array.from(activityClassesSelect.selectedOptions).map(option => option.value);
                
                console.log('Création activité:', { name, delay, selectedClasses });
                
                // Collect questions
                const questions = [];
                const questionInputs = questionsContainer.querySelectorAll('.question-text');
                const answerInputs = questionsContainer.querySelectorAll('.question-answer');
                
                for (let i = 0; i < questionInputs.length; i++) {
                    const questionText = questionInputs[i].value.trim();
                    const answerText = answerInputs[i].value.trim();
                    
                    if (questionText && answerText) {
                        questions.push({
                            id: questionInputs[i].getAttribute('data-id'),
                            text: questionText,
                            answer: answerText
                        });
                    }
                }
                
                // Validate inputs
                if (!name) {
                    alert('Veuillez donner un nom à votre activité');
                    return;
                }
                
                if (selectedClasses.length === 0) {
                    alert('Veuillez sélectionner au moins une classe');
                    return;
                }
                
                if (questions.length === 0) {
                    alert('Veuillez ajouter au moins une question');
                    return;
                }
                
                // Create activity object
                const activity = {
                    id: Date.now(),
                    name,
                    delay,
                    classes: selectedClasses,
                    questions,
                    createdAt: new Date().toISOString()
                };
                
                console.log('Activité créée:', activity);
                
                // Save activity
                activities.push(activity);
                const success = await saveActivities();
                
                if (success) {
                    // Reset form
                    activityNameInput.value = '';
                    activityDelayInput.value = '30';
                    // Réinitialiser la sélection des classes
                    Array.from(activityClassesSelect.options).forEach(option => {
                        option.selected = false;
                    });
                    questionsContainer.innerHTML = '';
                    questionCount = 0;
                    
                    // Update UI
                    renderActivitiesList();
                    
                    alert('Activité enregistrée avec succès!');
                } else {
                    alert('Erreur lors de la sauvegarde. Les données seront stockées localement.');
                }
            });
            
            // Render classes list
            function renderClassesList() {
                console.log('Rendu des classes:', classes);
                
                if (classes.length === 0) {
                    classesList.innerHTML = `
                        <div class="p-4 border border-gray-200 rounded-md text-center">
                            <p class="text-gray-500">Aucune classe créée pour le moment</p>
                        </div>
                    `;
                    return;
                }
                
                classesList.innerHTML = '';
                classes.forEach(classItem => {
                    const classElement = document.createElement('div');
                    classElement.classList.add('activity-card', 'p-4', 'border', 'border-gray-200', 'rounded-md');
                    classElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-medium text-gray-800">${classItem.name}</h3>
                                <p class="text-sm text-gray-600">${classItem.students ? classItem.students.length : 0} élèves</p>
                                <p class="text-xs text-gray-500">Créé le ${new Date(classItem.createdAt).toLocaleDateString()}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="px-3 py-1 bg-blue-500 text-white text-sm rounded-md edit-class" data-id="${classItem.id}">Modifier</button>
                                <button class="px-3 py-1 bg-red-500 text-white text-sm rounded-md delete-class" data-id="${classItem.id}">Supprimer</button>
                            </div>
                        </div>
                    `;
                    classesList.appendChild(classElement);
                    
                    // Add event listeners
                    classElement.querySelector('.edit-class').addEventListener('click', function() {
                        const classId = this.getAttribute('data-id');
                        openEditClassModal(classId);
                    });
                    
                    classElement.querySelector('.delete-class').addEventListener('click', async function() {
                        const classId = this.getAttribute('data-id');
                        if (confirm(`Êtes-vous sûr de vouloir supprimer cette classe ?`)) {
                            await deleteClass(classId);
                        }
                    });
                });
            }
            
            // Render activities list
            function renderActivitiesList() {
                console.log('Rendu des activités:', activities);
                
                if (activities.length === 0) {
                    activitiesList.innerHTML = `
                        <div class="p-4 border border-gray-200 rounded-md text-center">
                            <p class="text-gray-500">Aucune activité créée pour le moment</p>
                        </div>
                    `;
                    return;
                }
                
                activitiesList.innerHTML = '';
                activities.forEach(activity => {
                    // Get class names for display
                    const classNames = activity.classes ? activity.classes.map(classId => {
                        const classItem = classes.find(c => c.id == classId);
                        return classItem ? classItem.name : 'Classe inconnue';
                    }).join(', ') : 'Aucune classe';
                    
                    const activityElement = document.createElement('div');
                    activityElement.classList.add('activity-card', 'p-4', 'border', 'border-gray-200', 'rounded-md');
                    activityElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-medium text-gray-800">${activity.name}</h3>
                                <p class="text-sm text-gray-600">${activity.questions ? activity.questions.length : 0} questions • Délai: ${activity.delay}s</p>
                                <p class="text-xs text-gray-500">Classes: ${classNames}</p>
                                <p class="text-xs text-gray-500">Créé le ${new Date(activity.createdAt).toLocaleDateString()}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="px-3 py-1 bg-blue-500 text-white text-sm rounded-md edit-activity" data-id="${activity.id}">Modifier</button>
                                <button class="px-3 py-1 bg-red-500 text-white text-sm rounded-md delete-activity" data-id="${activity.id}">Supprimer</button>
                            </div>
                        </div>
                    `;
                    activitiesList.appendChild(activityElement);
                    
                    // Add event listeners
                    activityElement.querySelector('.edit-activity').addEventListener('click', function() {
                        const activityId = this.getAttribute('data-id');
                        openEditActivityModal(activityId);
                    });
                    
                    activityElement.querySelector('.delete-activity').addEventListener('click', async function() {
                        const activityId = this.getAttribute('data-id');
                        if (confirm(`Êtes-vous sûr de vouloir supprimer cette activité ?`)) {
                            await deleteActivity(activityId);
                        }
                    });
                });
            }
            
            // Render results list
            function renderResultsList() {
                const resultsContainer = document.getElementById('results-container');
                const activityFilter = document.getElementById('result-activity-filter');
                const studentFilter = document.getElementById('result-student-filter');
                
                // Mettre à jour les filtres
                activityFilter.innerHTML = '<option value="all">Toutes les activités</option>';
                activities.forEach(activity => {
                    const option = document.createElement('option');
                    option.value = activity.id;
                    option.textContent = activity.name;
                    activityFilter.appendChild(option);
                });
                
                studentFilter.innerHTML = '<option value="all">Tous les élèves</option>';
                const uniqueStudents = [...new Set(results.map(r => r.studentName))];
                uniqueStudents.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student;
                    option.textContent = student;
                    studentFilter.appendChild(option);
                });
                
                // Filtrer les résultats
                const filteredResults = results.filter(result => {
                    const activityMatch = activityFilter.value === 'all' || result.activityId == activityFilter.value;
                    const studentMatch = studentFilter.value === 'all' || result.studentName === studentFilter.value;
                    return activityMatch && studentMatch;
                });
                
                if (filteredResults.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Aucun résultat à afficher pour le moment</p>';
                    return;
                }
                
                // Afficher les résultats
                resultsContainer.innerHTML = '';
                filteredResults.forEach(result => {
                    const resultElement = document.createElement('div');
                    resultElement.classList.add('p-4', 'border', 'border-gray-200', 'rounded-md', 'mb-3');
                    resultElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-medium">${result.studentName} - ${result.activityName}</h4>
                                <p class="text-sm text-gray-600">${result.questionText}</p>
                                <p class="text-xs text-gray-500">${new Date(result.timestamp).toLocaleString()}</p>
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 rounded text-xs ${result.isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${result.isCorrect ? 'Correct' : 'Incorrect'}
                                </span>
                                <p class="text-xs mt-1">Réponse: "${result.studentAnswer}"</p>
                            </div>
                        </div>
                    `;
                    resultsContainer.appendChild(resultElement);
                });
            }
            
            // Open edit class modal
            function openEditClassModal(classId) {
                currentEditingClass = classes.find(c => c.id == classId);
                
                if (!currentEditingClass) return;
                
                editClassForm.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nom de la classe</label>
                            <input type="text" id="edit-class-name" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${currentEditingClass.name}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Liste des élèves (un par ligne)</label>
                            <textarea id="edit-class-student-list" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md">${currentEditingClass.students ? currentEditingClass.students.join('\n') : ''}</textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400" id="cancel-edit-class">Annuler</button>
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" id="save-edit-class">Enregistrer</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('save-edit-class').addEventListener('click', saveEditedClass);
                document.getElementById('cancel-edit-class').addEventListener('click', closeEditClassModal);
                
                editClassModal.style.display = 'block';
            }
            
            // Save edited class
            async function saveEditedClass() {
                const name = document.getElementById('edit-class-name').value.trim();
                const studentsText = document.getElementById('edit-class-student-list').value;
                
                // Nettoyer la liste des élèves
                const students = studentsText.split('\n')
                    .map(s => s.trim())
                    .filter(s => s);
                
                // Validate inputs
                if (!name) {
                    alert('Veuillez donner un nom à votre classe');
                    return;
                }
                
                if (students.length === 0) {
                    alert('Veuillez ajouter au moins un élève');
                    return;
                }
                
                // Update class object
                currentEditingClass.name = name;
                currentEditingClass.students = students;
                
                // Update classes array
                const index = classes.findIndex(c => c.id === currentEditingClass.id);
                if (index !== -1) {
                    classes[index] = currentEditingClass;
                }
                
                // Save to Firebase
                const success = await saveClasses();
                
                if (success) {
                    // Update UI
                    renderClassesList();
                    populateClassSelect();
                    populateActivityClasses();
                    
                    // Close modal
                    closeEditClassModal();
                    
                    alert('Classe modifiée avec succès!');
                } else {
                    alert('Erreur lors de la sauvegarde. Les données seront stockées localement.');
                }
            }
            
            // Close edit class modal
            function closeEditClassModal() {
                editClassModal.style.display = 'none';
                currentEditingClass = null;
            }
            
            // Delete class
            async function deleteClass(classId) {
                classes = classes.filter(c => c.id != classId);
                const success = await saveClasses();
                
                if (success) {
                    renderClassesList();
                    populateClassSelect();
                    populateActivityClasses();
                    alert('Classe supprimée avec succès!');
                } else {
                    alert('Erreur lors de la suppression. Les données seront stockées localement.');
                }
            }
            
            // Open edit activity modal
            function openEditActivityModal(activityId) {
                currentEditingActivity = activities.find(a => a.id == activityId);
                
                if (!currentEditingActivity) return;
                
                // Get class names for selected classes
                const selectedClasses = currentEditingActivity.classes || [];
                
                editActivityForm.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nom de l'activité</label>
                            <input type="text" id="edit-activity-name" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${currentEditingActivity.name}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Délai entre les tentatives (secondes)</label>
                            <input type="number" id="edit-activity-delay" value="${currentEditingActivity.delay}" min="5" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Classes concernées</label>
                            <select id="edit-activity-classes" class="w-full px-3 py-2 border border-gray-300 rounded-md" multiple>
                                ${classes.map(classItem => `
                                    <option value="${classItem.id}" ${selectedClasses.includes(classItem.id.toString()) ? 'selected' : ''}>${classItem.name}</option>
                                `).join('')}
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Maintenez Ctrl (ou Cmd) pour sélectionner plusieurs classes</p>
                        </div>
                        
                        <div class="mt-6">
                            <h3 class="font-medium text-gray-800 mb-3">Questions de l'activité</h3>
                            <div id="edit-questions-container" class="space-y-3">
                                ${currentEditingActivity.questions ? currentEditingActivity.questions.map((q, i) => `
                                    <div class="question-item p-3 border border-gray-200 rounded-md">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <div>
                                                <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md edit-question-text" value="${q.text}" data-id="${q.id}">
                                            </div>
                                            <div>
                                                <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md edit-question-answer" value="${q.answer}" data-id="${q.id}">
                                            </div>
                                        </div>
                                        <button class="mt-2 px-3 py-1 bg-red-500 text-white text-sm rounded-md delete-question" data-id="${q.id}">Supprimer</button>
                                    </div>
                                `).join('') : ''}
                            </div>
                            <button id="edit-add-question-btn" class="mt-3 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                                + Ajouter une question
                            </button>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400" id="cancel-edit">Annuler</button>
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" id="save-edit-activity">Enregistrer</button>
                        </div>
                    </div>
                `;
                
                // Add event listeners for the edit form
                document.getElementById('edit-add-question-btn').addEventListener('click', function() {
                    const questionId = Date.now();
                    const questionElement = document.createElement('div');
                    questionElement.classList.add('question-item', 'p-3', 'border', 'border-gray-200', 'rounded-md');
                    questionElement.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md edit-question-text" placeholder="Nouvelle question" data-id="${questionId}">
                            </div>
                            <div>
                                <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md edit-question-answer" placeholder="Réponse attendue" data-id="${questionId}">
                            </div>
                        </div>
                        <button class="mt-2 px-3 py-1 bg-red-500 text-white text-sm rounded-md delete-question" data-id="${questionId}">Supprimer</button>
                    `;
                    
                    // Add delete event listener
                    questionElement.querySelector('.delete-question').addEventListener('click', function() {
                        questionElement.remove();
                    });
                    
                    document.getElementById('edit-questions-container').appendChild(questionElement);
                });
                
                // Add delete event listeners for existing questions
                document.querySelectorAll('#edit-questions-container .delete-question').forEach(btn => {
                    btn.addEventListener('click', function() {
                        this.closest('.question-item').remove();
                    });
                });
                
                document.getElementById('save-edit-activity').addEventListener('click', saveEditedActivity);
                document.getElementById('cancel-edit').addEventListener('click', closeEditActivityModal);
                
                editActivityModal.style.display = 'block';
            }
            
            // Save edited activity
            async function saveEditedActivity() {
                const name = document.getElementById('edit-activity-name').value.trim();
                const delay = parseInt(document.getElementById('edit-activity-delay').value);
                const selectedClasses = Array.from(document.getElementById('edit-activity-classes').selectedOptions).map(option => option.value);
                
                // Collect questions
                const questions = [];
                const questionInputs = document.querySelectorAll('.edit-question-text');
                const answerInputs = document.querySelectorAll('.edit-question-answer');
                
                for (let i = 0; i < questionInputs.length; i++) {
                    const questionText = questionInputs[i].value.trim();
                    const answerText = answerInputs[i].value.trim();
                    
                    if (questionText && answerText) {
                        questions.push({
                            id: questionInputs[i].getAttribute('data-id'),
                            text: questionText,
                            answer: answerText
                        });
                    }
                }
                
                // Validate inputs
                if (!name) {
                    alert('Veuillez donner un nom à votre activité');
                    return;
                }
                
                if (selectedClasses.length === 0) {
                    alert('Veuillez sélectionner au moins une classe');
                    return;
                }
                
                if (questions.length === 0) {
                    alert('Veuillez ajouter au moins une question');
                    return;
                }
                
                // Update activity object
                currentEditingActivity.name = name;
                currentEditingActivity.delay = delay;
                currentEditingActivity.classes = selectedClasses;
                currentEditingActivity.questions = questions;
                
                // Update activities array
                const index = activities.findIndex(a => a.id === currentEditingActivity.id);
                if (index !== -1) {
                    activities[index] = currentEditingActivity;
                }
                
                // Save to Firebase
                const success = await saveActivities();
                
                if (success) {
                    // Update UI
                    renderActivitiesList();
                    
                    // Close modal
                    closeEditActivityModal();
                    
                    alert('Activité modifiée avec succès!');
                } else {
                    alert('Erreur lors de la sauvegarde. Les données seront stockées localement.');
                }
            }
            
            // Close edit activity modal
            function closeEditActivityModal() {
                editActivityModal.style.display = 'none';
                currentEditingActivity = null;
            }
            
            // Delete activity
            async function deleteActivity(activityId) {
                activities = activities.filter(a => a.id != activityId);
                const success = await saveActivities();
                
                if (success) {
                    renderActivitiesList();
                    alert('Activité supprimée avec succès!');
                } else {
                    alert('Erreur lors de la suppression. Les données seront stockées localement.');
                }
            }
            
            // Close modals when clicking on X
            closeModalButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    modal.style.display = 'none';
                    
                    if (modal.id === 'edit-activity-modal') {
                        currentEditingActivity = null;
                    } else if (modal.id === 'edit-class-modal') {
                        currentEditingClass = null;
                    }
                });
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === editActivityModal) {
                    closeEditActivityModal();
                } else if (event.target === editClassModal) {
                    closeEditClassModal();
                }
            });
            
            // Update results summary
            function updateResultsSummary() {
                const totalAttempts = results.length;
                const correctAnswers = results.filter(r => r.isCorrect).length;
                const averageScore = totalAttempts > 0 ? Math.round((correctAnswers / totalAttempts) * 100) : 0;
                
                document.getElementById('total-attempts').textContent = totalAttempts;
                document.getElementById('correct-answers').textContent = correctAnswers;
                document.getElementById('average-score').textContent = averageScore + '%';
            }
            
            // Export activities
            exportActivitiesBtn.addEventListener('click', function() {
                const data = {
                    classes: classes,
                    activities: activities,
                    results: results
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = 'donnees_plateforme.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            });
            
            // Generate student file
            generateStudentFileBtn.addEventListener('click', function() {
                alert('Fonctionnalité à implémenter: Génération du fichier élève');
            });
            
            // Initialize the application
            init();
            
            // Add Enter key support for password field
            teacherPasswordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginBtn.click();
                }
            });
        });
    </script>
</body>
</html>
