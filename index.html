<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme Enseignant et Élève - Outil d'Autocorrection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Intégration Firebase -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQ2x6iR0yeQE0mGvWKnEe4H01fhhr91JM",
            authDomain: "ateliers-af899.firebaseapp.com",
            databaseURL: "https://ateliers-af899-default-rtdb.firebaseio.com",
            projectId: "ateliers-af899",
            storageBucket: "ateliers-af899.firebasestorage.app",
            messagingSenderId: "297753369500",
            appId: "1:297753369500:web:7177e451c0e619fe064659",
            measurementId: "G-V80VY8XMPY"
        };

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            const database = getDatabase(app);

            console.log('Firebase initialisé avec succès');
            
            // Rendre Firebase accessible globalement
            window.firebaseApp = app;
            window.firebaseDatabase = database;
            window.firebaseRef = ref;
            window.firebaseSet = set;
            window.firebaseGet = get;
            window.firebaseChild = child;
            window.firebaseInitialized = true;
            
            // Mettre à jour le statut
            updateFirebaseStatus('Firebase: Connecté', true);
            
        } catch (error) {
            console.error('Erreur lors de l\'initialisation de Firebase:', error);
            window.firebaseInitialized = false;
            updateFirebaseStatus('Firebase: Erreur d\'initialisation', false);
        }

        function updateFirebaseStatus(message, isConnected) {
            const statusElement = document.getElementById('firebase-status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = isConnected ? 
                    'firebase-status firebase-connected' : 
                    'firebase-status firebase-error';
            }
        }
    </script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background: #4338ca;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .tab-button.active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        .question-item {
            transition: all 0.3s ease;
        }
        .question-item:hover {
            background-color: #f8fafc;
        }
        .activity-card {
            transition: all 0.3s ease;
        }
        .activity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.1);
        }
        .student-platform {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .platform-switcher {
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .student-header {
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 1rem;
            border-radius: 12px 12px 0 0;
        }
        .countdown {
            display: inline-block;
            padding: 2px 8px;
            background-color: #ef4444;
            color: white;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        .firebase-connected {
            background-color: #10b981;
            color: white;
        }
        .firebase-disconnected {
            background-color: #ef4444;
            color: white;
        }
        .firebase-error {
            background-color: #f59e0b;
            color: white;
        }
        .completed-badge {
            background-color: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <!-- Indicateur de statut Firebase -->
    <div id="firebase-status" class="firebase-status firebase-error">
        Firebase: Chargement...
    </div>

    <!-- Barre de navigation pour switcher entre les plateformes -->
    <div class="platform-switcher py-3 px-4 text-white">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Outil d'Autocorrection</h1>
            <div class="flex space-x-4">
                <button id="show-student-btn" class="px-4 py-2 bg-white text-purple-700 rounded-lg font-medium">Plateforme Élève</button>
                <button id="show-teacher-btn" class="px-4 py-2 bg-purple-500 text-white rounded-lg font-medium hover:bg-purple-600">Plateforme Enseignant</button>
            </div>
        </div>
    </div>

    <!-- Section Élève (visible par défaut) -->
    <div id="student-platform" class="student-platform">
        <div class="container max-w-4xl mx-auto">
            <div class="card">
                <!-- En-tête de la plateforme élève -->
                <div class="student-header flex justify-between items-center">
                    <h1 class="text-2xl font-bold">Espace Élève</h1>
                    <div id="student-welcome" class="hidden">
                        <span class="mr-4">Connecté en tant que: <strong id="current-student-name"></strong></span>
                        <button id="student-logout-btn" class="px-3 py-1 bg-white text-purple-700 rounded-md text-sm hover:bg-gray-100">
                            Déconnexion
                        </button>
                    </div>
                </div>
                
                <div class="p-8">
                    <div id="student-login-section">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-800">Connexion Élève</h2>
                            <p class="text-gray-600 mt-2">Sélectionnez votre classe et votre nom pour accéder aux activités</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sélectionnez votre classe</label>
                                <select id="class-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Choisissez votre classe</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sélectionnez votre nom</label>
                                <select id="student-name-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                                    <option value="">Choisissez votre nom</option>
                                </select>
                            </div>
                        </div>
                        
                        <button id="student-login-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" disabled>
                            Se connecter
                        </button>
                    </div>
                    
                    <div id="student-activities" class="hidden mt-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Vos activités</h2>
                        <div id="activities-container" class="space-y-4">
                            <!-- Activities will be loaded here -->
                        </div>
                    </div>
                    
                    <div id="student-activity-content" class="hidden mt-8">
                        <h2 id="current-activity-title" class="text-xl font-bold text-gray-800 mb-4"></h2>
                        <div id="questions-list" class="space-y-6">
                            <!-- Questions will be loaded here -->
                        </div>
                        
                        <button id="back-to-activities" class="mt-6 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                            ← Retour aux activités
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Le reste du code HTML reste inchangé -->
    <!-- ... -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Constants
            const TEACHER_PASSWORD = 'prof123';
            
            // DOM Elements
            const teacherPlatform = document.getElementById('teacher-platform');
            const studentPlatform = document.getElementById('student-platform');
            const showTeacherBtn = document.getElementById('show-teacher-btn');
            const showStudentBtn = document.getElementById('show-student-btn');
            const loginSection = document.getElementById('login-section');
            const teacherSection = document.getElementById('teacher-section');
            const teacherPasswordInput = document.getElementById('teacher-password');
            const loginBtn = document.getElementById('login-btn');
            const passwordError = document.getElementById('password-error');
            const logoutBtn = document.getElementById('logout-btn');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanes = document.querySelectorAll('.tab-pane');
            const firebaseStatus = document.getElementById('firebase-status');
            
            // Class management elements
            const classNameInput = document.getElementById('class-name');
            const classStudentList = document.getElementById('class-student-list');
            const saveClassBtn = document.getElementById('save-class-btn');
            const classesList = document.getElementById('classes-list');
            
            // Activity management elements
            const activityNameInput = document.getElementById('activity-name');
            const activityDelayInput = document.getElementById('activity-delay');
            const addQuestionBtn = document.getElementById('add-question-btn');
            const questionsContainer = document.getElementById('questions-container');
            const saveActivityBtn = document.getElementById('save-activity-btn');
            const activitiesList = document.getElementById('activities-list');
            const activityClassesSelect = document.getElementById('activity-classes');
            const exportActivitiesBtn = document.getElementById('export-activities-btn');
            const generateStudentFileBtn = document.getElementById('generate-student-file-btn');
            
            // Student platform elements
            const classSelect = document.getElementById('class-select');
            const studentLoginSection = document.getElementById('student-login-section');
            const studentNameSelect = document.getElementById('student-name-select');
            const studentLoginBtn = document.getElementById('student-login-btn');
            const studentWelcome = document.getElementById('student-welcome');
            const currentStudentName = document.getElementById('current-student-name');
            const studentLogoutBtn = document.getElementById('student-logout-btn');
            const studentActivities = document.getElementById('student-activities');
            const studentActivityContent = document.getElementById('student-activity-content');
            const activitiesContainer = document.getElementById('activities-container');
            const questionsList = document.getElementById('questions-list');
            const currentActivityTitle = document.getElementById('current-activity-title');
            const backToActivities = document.getElementById('back-to-activities');
            
            // Modal elements
            const editActivityModal = document.getElementById('edit-activity-modal');
            const editActivityForm = document.getElementById('edit-activity-form');
            const editClassModal = document.getElementById('edit-class-modal');
            const editClassForm = document.getElementById('edit-class-form');
            const closeModalButtons = document.querySelectorAll('.close-button');
            
            // State
            let classes = [];
            let activities = [];
            let results = [];
            let studentAnswers = {};
            let questionCount = 0;
            let currentStudent = null;
            let currentActivity = null;
            let currentEditingActivity = null;
            let currentEditingClass = null;
            let questionTimeouts = {};
            
            // Firebase Functions
            async function saveToFirebase(path, data) {
                // Sauvegarde locale par défaut
                localStorage.setItem(path, JSON.stringify(data));
                
                // Tentative de sauvegarde Firebase
                if (window.firebaseInitialized) {
                    try {
                        await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, path), data);
                        console.log('✅ Données sauvegardées sur Firebase');
                        updateFirebaseStatus('Firebase: Connecté', true);
                        return true;
                    } catch (error) {
                        console.warn('❌ Erreur Firebase, utilisation du stockage local:', error);
                        updateFirebaseStatus('Firebase: Erreur de sauvegarde', false);
                        return false;
                    }
                } else {
                    console.warn('Firebase non initialisé, utilisation du stockage local');
                    return false;
                }
            }
            
            async function loadFromFirebase(path) {
                // D'abord essayer Firebase
                if (window.firebaseInitialized) {
                    try {
                        const snapshot = await window.firebaseGet(
                            window.firebaseChild(window.firebaseRef(window.firebaseDatabase), path)
                        );
                        if (snapshot.exists()) {
                            console.log('✅ Données chargées depuis Firebase');
                            updateFirebaseStatus('Firebase: Connecté', true);
                            return snapshot.val();
                        }
                    } catch (error) {
                        console.warn('❌ Erreur Firebase, utilisation du stockage local:', error);
                        updateFirebaseStatus('Firebase: Erreur de chargement', false);
                    }
                }
                
                // Fallback au localStorage
                const localData = localStorage.getItem(path);
                if (localData) {
                    console.log('📁 Données chargées depuis le stockage local');
                    return JSON.parse(localData);
                }
                return null;
            }

            function updateFirebaseStatus(message, isConnected) {
                const statusElement = document.getElementById('firebase-status');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = isConnected ? 
                        'firebase-status firebase-connected' : 
                        'firebase-status firebase-error';
                }
            }
            
            async function saveClasses() {
                const classesObject = {};
                classes.forEach((classItem, index) => {
                    classesObject[index] = classItem;
                });
                return await saveToFirebase('classes', classesObject);
            }
            
            async function saveActivities() {
                const activitiesObject = {};
                activities.forEach((activity, index) => {
                    activitiesObject[index] = activity;
                });
                return await saveToFirebase('activities', activitiesObject);
            }
            
            async function saveResults() {
                const resultsObject = {};
                results.forEach((result, index) => {
                    resultsObject[index] = result;
                });
                return await saveToFirebase('results', resultsObject);
            }
            
            async function saveStudentAnswers() {
                return await saveToFirebase('studentAnswers', studentAnswers);
            }
            
            // Initialize the app
            async function init() {
                console.log('🚀 Initialisation de l\'application...');
                
                // Attendre que Firebase soit chargé
                let firebaseLoaded = false;
                for (let i = 0; i < 50; i++) {
                    if (window.firebaseInitialized !== undefined) {
                        firebaseLoaded = true;
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                if (!firebaseLoaded) {
                    console.warn('Firebase ne s\'est pas initialisé dans le délai imparti');
                    updateFirebaseStatus('Firebase: Timeout', false);
                }
                
                await loadData();
                renderClassesList();
                renderActivitiesList();
                updateResultsSummary();
                populateClassSelect();
                populateActivityClasses();
                
                // Afficher la plateforme élève par défaut
                showStudentPlatform();
                
                console.log('✅ Application initialisée');
            }
            
            async function loadData() {
                // Charger les classes depuis Firebase
                const classesData = await loadFromFirebase('classes');
                classes = classesData ? Object.values(classesData) : [];
                
                // Charger les activités depuis Firebase
                const activitiesData = await loadFromFirebase('activities');
                activities = activitiesData ? Object.values(activitiesData) : [];
                
                // Charger les résultats depuis Firebase
                const resultsData = await loadFromFirebase('results');
                results = resultsData ? Object.values(resultsData) : [];
                
                // Charger les réponses des élèves
                const answersData = await loadFromFirebase('studentAnswers');
                studentAnswers = answersData || {};
                
                console.log('Données chargées:', { classes, activities, results, studentAnswers });
            }
            
            // CORRECTION : Fonction améliorée pour charger les activités de l'élève
            function loadStudentActivities() {
                console.log('Chargement des activités pour:', currentStudent);
                activitiesContainer.innerHTML = '';
                
                if (!currentStudent || !currentStudent.classId) {
                    console.error('Erreur: currentStudent ou classId manquant');
                    activitiesContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Erreur de chargement des activités</p>';
                    return;
                }
                
                // Filtrer les activités pour ne montrer que celles assignées à la classe de l'élève
                const studentActivitiesList = activities.filter(activity => {
                    if (!activity.classes) {
                        console.log('Activité sans classes:', activity.name);
                        return false;
                    }
                    const isAssigned = activity.classes.includes(currentStudent.classId);
                    console.log('Activité:', activity.name, 'assignée à la classe:', isAssigned);
                    return isAssigned;
                });
                
                console.log('Activités filtrées pour élève:', studentActivitiesList);
                
                if (studentActivitiesList.length === 0) {
                    activitiesContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Aucune activité disponible pour le moment</p>';
                    return;
                }
                
                studentActivitiesList.forEach(activity => {
                    // Vérifier si l'activité est complétée
                    const studentKey = `${currentStudent.name}_${currentStudent.classId}`;
                    const activityKey = `${activity.id}`;
                    const isCompleted = studentAnswers[studentKey] && 
                                       studentAnswers[studentKey][activityKey] &&
                                       Object.keys(studentAnswers[studentKey][activityKey]).length === activity.questions.length;
                    
                    const activityElement = document.createElement('div');
                    activityElement.classList.add('p-4', 'border', 'border-gray-200', 'rounded-md', 'hover:bg-gray-50', 'cursor-pointer');
                    activityElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-medium text-gray-800">${activity.name}</h3>
                                <p class="text-sm text-gray-600">${activity.questions ? activity.questions.length : 0} questions • Délai: ${activity.delay}s</p>
                            </div>
                            ${isCompleted ? '<span class="completed-badge">Terminée</span>' : ''}
                        </div>
                    `;
                    
                    activityElement.addEventListener('click', () => {
                        console.log('Activité cliquée:', activity.name);
                        currentActivity = activity;
                        loadActivityQuestions();
                    });
                    
                    activitiesContainer.appendChild(activityElement);
                });
            }

            // Load activity questions with answer validation
            function loadActivityQuestions() {
                console.log('Chargement des questions pour l\'activité:', currentActivity?.name);
                
                if (!currentActivity) {
                    console.error('Erreur: currentActivity manquant');
                    return;
                }
                
                studentActivities.classList.add('hidden');
                studentActivityContent.classList.remove('hidden');
                currentActivityTitle.textContent = currentActivity.name;
                
                questionsList.innerHTML = '';
                
                if (!currentActivity.questions || currentActivity.questions.length === 0) {
                    questionsList.innerHTML = '<p class="text-gray-500 text-center py-4">Aucune question dans cette activité</p>';
                    return;
                }
                
                // Récupérer les réponses précédentes de l'élève
                const studentKey = `${currentStudent.name}_${currentStudent.classId}`;
                const activityKey = `${currentActivity.id}`;
                const previousAnswers = studentAnswers[studentKey] && studentAnswers[studentKey][activityKey] 
                    ? studentAnswers[studentKey][activityKey] 
                    : {};
                
                currentActivity.questions.forEach((question, index) => {
                    const previousAnswer = previousAnswers[question.id] || '';
                    const isCorrect = previousAnswer && previousAnswer.toLowerCase() === question.answer.toLowerCase();
                    
                    const questionElement = document.createElement('div');
                    questionElement.classList.add('p-4', 'bg-gray-50', 'rounded-md');
                    questionElement.innerHTML = `
                        <h3 class="font-medium text-gray-800 mb-2">Question ${index + 1}</h3>
                        <p class="text-gray-700 mb-3">${question.text}</p>
                        <input type="text" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md student-answer" 
                               placeholder="Votre réponse" 
                               data-question-id="${question.id}"
                               value="${previousAnswer}">
                        <div class="feedback mt-2 text-sm ${previousAnswer ? '' : 'hidden'}">
                            ${previousAnswer ? (isCorrect ? 
                                '<span class="text-green-600 font-bold">✓ Réponse correcte</span>' : 
                                '<span class="text-red-600 font-bold">✗ Réponse incorrecte</span>') : ''}
                        </div>
                    `;
                    
                    const answerInput = questionElement.querySelector('.student-answer');
                    const feedbackEl = questionElement.querySelector('.feedback');
                    
                    // Si déjà répondu, désactiver le champ
                    if (previousAnswer) {
                        answerInput.disabled = true;
                        answerInput.classList.add(isCorrect ? 'bg-green-100 border-green-400' : 'bg-red-100 border-red-400');
                    }
                    
                    answerInput.addEventListener('blur', () => {
                        validateAnswer(question, answerInput, feedbackEl);
                    });
                    
                    answerInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            validateAnswer(question, answerInput, feedbackEl);
                        }
                    });
                    
                    questionsList.appendChild(questionElement);
                });
            }
            
            // Validate student answer with delay
            function validateAnswer(question, inputElement, feedbackEl) {
                const userAnswer = inputElement.value.trim();
                
                if (!userAnswer) return;
                
                const isCorrect = userAnswer.toLowerCase() === question.answer.toLowerCase();
                
                // Sauvegarder la réponse de l'élève
                saveStudentAnswer(question, userAnswer, isCorrect);
                
                if (isCorrect) {
                    feedbackEl.innerHTML = '<span class="text-green-600 font-bold">✓ Réponse correcte</span>';
                    feedbackEl.classList.remove('hidden');
                    inputElement.disabled = true;
                    inputElement.classList.add('bg-green-100', 'border-green-400');
                } else {
                    feedbackEl.innerHTML = `<span class="text-red-600 font-bold">✗ Réponse incorrecte. Vous pourrez réessayer dans ${currentActivity.delay} secondes.</span>`;
                    feedbackEl.classList.remove('hidden');
                    inputElement.disabled = true;
                    inputElement.classList.add('bg-red-100', 'border-red-400');
                    
                    // Set timeout to allow retry after delay
                    const questionId = question.id;
                    
                    if (questionTimeouts[questionId]) {
                        clearTimeout(questionTimeouts[questionId]);
                    }
                    
                    let secondsLeft = currentActivity.delay;
                    
                    questionTimeouts[questionId] = setInterval(() => {
                        secondsLeft--;
                        
                        if (secondsLeft <= 0) {
                            clearInterval(questionTimeouts[questionId]);
                            inputElement.disabled = false;
                            inputElement.classList.remove('bg-red-100', 'border-red-400');
                            feedbackEl.classList.add('hidden');
                            delete questionTimeouts[questionId];
                        } else {
                            feedbackEl.innerHTML = `<span class="text-red-600 font-bold">✗ Réponse incorrecte. Vous pourrez réessayer dans ${secondsLeft} secondes.</span>`;
                        }
                    }, 1000);
                }
                
                // Sauvegarder le résultat pour les statistiques
                saveResult(currentStudent, currentActivity, question, isCorrect);
            }
            
            // Sauvegarder la réponse de l'élève
            async function saveStudentAnswer(question, answer, isCorrect) {
                const studentKey = `${currentStudent.name}_${currentStudent.classId}`;
                const activityKey = `${currentActivity.id}`;
                
                console.log('Sauvegarde réponse pour:', studentKey, 'activité:', activityKey);
                
                // Initialiser la structure si nécessaire
                if (!studentAnswers[studentKey]) {
                    studentAnswers[studentKey] = {};
                }
                if (!studentAnswers[studentKey][activityKey]) {
                    studentAnswers[studentKey][activityKey] = {};
                }
                
                // Sauvegarder la réponse
                studentAnswers[studentKey][activityKey][question.id] = answer;
                
                // Sauvegarder dans Firebase
                await saveStudentAnswers();
                
                console.log('Réponse sauvegardée pour', currentStudent.name, ':', answer);
            }
            
            // Sauvegarder un résultat pour les statistiques
            async function saveResult(student, activity, question, isCorrect) {
                const result = {
                    id: Date.now(),
                    studentName: student.name,
                    studentClass: student.className,
                    activityId: activity.id,
                    activityName: activity.name,
                    questionId: question.id,
                    questionText: question.text,
                    studentAnswer: document.querySelector(`[data-question-id="${question.id}"]`).value,
                    correctAnswer: question.answer,
                    isCorrect: isCorrect,
                    timestamp: new Date().toISOString()
                };
                
                results.push(result);
                await saveResults();
                updateResultsSummary();
            }
            
            // CORRECTION : Fonction backToActivities améliorée
            backToActivities.addEventListener('click', function() {
                console.log('Retour aux activités');
                
                // Clear all timeouts
                Object.values(questionTimeouts).forEach(timeout => {
                    clearInterval(timeout);
                });
                questionTimeouts = {};
                
                studentActivityContent.classList.add('hidden');
                studentActivities.classList.remove('hidden');
                currentActivity = null;
                
                // Recharger les données AVANT de recharger les activités
                loadData().then(() => {
                    // Recharger les activités pour mettre à jour le statut "Terminée"
                    loadStudentActivities();
                }).catch(error => {
                    console.error('Erreur lors du rechargement des données:', error);
                    // En cas d'erreur, essayer quand même de recharger les activités
                    loadStudentActivities();
                });
            });

            // Le reste des fonctions reste inchangé...
            // [Toutes les autres fonctions identiques]

            // Student login functionality - CORRECTION
            studentLoginBtn.addEventListener('click', function() {
                const className = classSelect.options[classSelect.selectedIndex].text;
                const studentName = studentNameSelect.value;
                const classId = classSelect.value;
                
                if (!studentName || !classId) {
                    alert('Veuillez sélectionner votre nom et votre classe');
                    return;
                }
                
                currentStudent = {
                    name: studentName,
                    className: className,
                    classId: classId
                };
                
                console.log('Élève connecté:', currentStudent);
                
                // Update UI
                studentLoginSection.classList.add('hidden');
                studentWelcome.classList.remove('hidden');
                studentActivities.classList.remove('hidden');
                currentStudentName.textContent = `${currentStudent.name} (${currentStudent.className})`;
                
                // Load student activities
                loadStudentActivities();
            });

            // ... [Le reste du code identique]

        });
    </script>
</body>
</html>
